name: Deploy Web

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm install --legacy-peer-deps

      # --- NEW STEP: MANUALLY CREATE CONFIG FILES ON SERVER ---
      - name: Create Config Files
        run: |
          mkdir -p src/services
          
          # 1. Create supabaseConfig.js
          echo "import { createClient } from '@supabase/supabase-js';" > src/services/supabaseConfig.js
          echo "import AsyncStorage from '@react-native-async-storage/async-storage';" >> src/services/supabaseConfig.js
          echo "const SUPABASE_URL = process.env.EXPO_PUBLIC_SUPABASE_URL;" >> src/services/supabaseConfig.js
          echo "const SUPABASE_KEY = process.env.EXPO_PUBLIC_SUPABASE_ANON_KEY;" >> src/services/supabaseConfig.js
          echo "export const supabase = createClient(SUPABASE_URL, SUPABASE_KEY, { auth: { storage: AsyncStorage, autoRefreshToken: true, persistSession: true, detectSessionInUrl: false } });" >> src/services/supabaseConfig.js

          # 2. Create firebaseConfig.js
          echo "import { initializeApp, getApps, getApp } from 'firebase/app';" > src/services/firebaseConfig.js
          echo "import { getAuth, getReactNativePersistence, initializeAuth } from 'firebase/auth';" >> src/services/firebaseConfig.js
          echo "import ReactNativeAsyncStorage from '@react-native-async-storage/async-storage';" >> src/services/firebaseConfig.js
          echo "const firebaseConfig = { apiKey: process.env.EXPO_PUBLIC_FIREBASE_API_KEY, authDomain: process.env.EXPO_PUBLIC_FIREBASE_AUTH_DOMAIN, projectId: process.env.EXPO_PUBLIC_FIREBASE_PROJECT_ID, storageBucket: process.env.EXPO_PUBLIC_FIREBASE_STORAGE_BUCKET, messagingSenderId: process.env.EXPO_PUBLIC_FIREBASE_MESSAGING_SENDER_ID, appId: process.env.EXPO_PUBLIC_FIREBASE_APP_ID };" >> src/services/firebaseConfig.js
          echo "let app; let auth; if (getApps().length === 0) { app = initializeApp(firebaseConfig); if (typeof window !== 'undefined') { auth = getAuth(app); } else { auth = initializeAuth(app, { persistence: getReactNativePersistence(ReactNativeAsyncStorage) }); } } else { app = getApp(); auth = getAuth(app); } export { app, auth };" >> src/services/firebaseConfig.js

      # --- END OF NEW STEP ---

      - name: Generate .env file
        run: |
          echo "EXPO_PUBLIC_SUPABASE_URL=${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}" >> .env
          echo "EXPO_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}" >> .env
          echo "EXPO_PUBLIC_FIREBASE_API_KEY=${{ secrets.EXPO_PUBLIC_FIREBASE_API_KEY }}" >> .env
          echo "EXPO_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ secrets.EXPO_PUBLIC_FIREBASE_AUTH_DOMAIN }}" >> .env
          echo "EXPO_PUBLIC_FIREBASE_PROJECT_ID=${{ secrets.EXPO_PUBLIC_FIREBASE_PROJECT_ID }}" >> .env
          echo "EXPO_PUBLIC_FIREBASE_STORAGE_BUCKET=${{ secrets.EXPO_PUBLIC_FIREBASE_STORAGE_BUCKET }}" >> .env
          echo "EXPO_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.EXPO_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}" >> .env
          echo "EXPO_PUBLIC_FIREBASE_APP_ID=${{ secrets.EXPO_PUBLIC_FIREBASE_APP_ID }}" >> .env

      - name: Build Website
        run: npx expo export --platform web

      - name: Add .nojekyll file
        run: touch dist/.nojekyll

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: gh-pages